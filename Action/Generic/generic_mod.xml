<html>
<head>
[JS:REF]
<script>
	
    [JS:CODE] 
var constraint=[constraintinfo];
var error=[error];
var warning=[warning];


function setConstraint(info) {
    if (!info) return;
    var first=true;
    undisplayConstraint();
    for (var i in info) {
	if (info[i].index == null) {
	    // mono value
	    var inp=window.parent.document.getElementById(info[i].id);
            if (first) {
		focusConstraint(inp);
		//first=false;
            }
            viewContraint(inp,info[i]);
	    
	} else {
            var linp=window.parent.getInputsByName('_'+info[i].id,window.parent.document.getElementById('T'+info[i].pid));
            for (var k=0;k<linp.length;k++) { // >
                if (info[i].index==k) {
                    var inp=linp[k];
                    if (first) {
			//first=false;
			focusConstraint(inp);
                    }
                    viewContraint(inp,info[i]);
		}
            }
	}
    }
    for (var i in info) {
      if (! info[i].displayed) {
         window.parent.displayWarningMsg(info[i].err);
       }
    }

}
function focusConstraint(inp) {
    if (inp) {
	var p=inp.parentNode;
	while (p && ((p.tagName != 'FIELDSET') || (! p.getAttribute('name'))) ) p=p.parentNode;
	if (p) {
	    var name=p.getAttribute('name');
	    if (name) {		
		var tab=window.parent.document.getElementById('TAB'+name.substr(3));
		tab.onmousedown.apply(tab,[]);
		tab.className='invalid';
		
	    }	
	}
	try {
	  inp.focus();
	  } catch (exception) {
          
         }
    } 
}
function viewContraint(inp, info) {
    if (inp) {
        if ((inp.style.display=='none') || (inp.type=='hidden')) {
                var oinp=inp.parentNode.firstChild;
                while (oinp && ((oinp.tagName!='INPUT' && oinp.tagName!='SELECT') || (oinp.type=='hidden' || ( oinp.style && oinp.style.display=='none')))) {
                   oinp=oinp.nextSibling;
                }
                if (oinp && oinp.tagName=='INPUT') inp=oinp;
                else {
                   if (oinp && oinp.tagName=='SELECT') inp=oinp;
                   else inp=inp.parentNode;
                }   
        }
        inp.className+=' invalid';
        var ntr=window.parent.document.createElement("div");
        ntr.className='constraint';     
        if (inp.id) {            
          var xy= window.parent.getAnchorPosition(inp.id);
          ntr.style.top=xy.y;
          ntr.style.left=xy.x;
        }
        var sp=window.parent.document.createElement("span");
        sp.innerHTML=info.err;
        info.displayed=true;
        ntr.appendChild(sp);
        addEvent(sp,"click", function () { ntr.style.display='none';inp.focus();});
        inp.parentNode.insertBefore(ntr,inp);
        
        if (info.sug && (info.sug.length > 0)) {
            var s=window.parent.document.createElement("select");
            s.options[s.options.length]=new Option('[TEXT:Suggestion]','');
            addEvent(s,"change", function () { inp.value=this.options[this.selectedIndex].value;});
            for (var i in info.sug) {
                s.options[s.options.length]=new Option(info.sug[i],info.sug[i]);   
            }
            ntr.appendChild(s);
        }
    }
}
function undisplayConstraint() {
    var ldiv=window.parent.document.getElementsByTagName('div');
    var retnode = [];
    for (var i=0;i<ldiv.length;i++) { //>
	if (ldiv[i].className=='constraint') {
	    ldiv[i].parentNode.removeChild(ldiv[i]);
	    i--;
	}
    }
    var itag=new Array('input','textarea','select');

    for (t in itag) {
	var ti= window.parent.document.getElementsByTagName(itag[t]);
	
	for (var i=0; i< ti.length; i++) {
	    if (ti[i].className.indexOf('invalid')>0) ti[i].className=ti[i].className.replace('invalid','');
	}
    }
}
if (window.parent) {
	if (window.parent.document) {
	    
	    var c=0;
	    for (var i in constraint) c++;
	    
	    if ((parseInt('[id]')>0) && (window.parent.document.modifydoc))  window.parent.document.modifydoc.id.value=parseInt('[id]');
	    var s=window.parent.document.getElementById('iSubmit');
	    if (error) {
		if (s) s.value='[TEXT:Save]';
		s=window.parent.document.getElementById('aSubmit');
		if (s) s.innerHTML='[TEXT:Save]';
		var s=window.parent.document.getElementById('iCancel');
		if (s) s.style.display='';
		var s=window.parent.document.getElementById('iSaveForce');
		if(window.parent && window.parent.displaySaveForce){
			window.parent.displaySaveForce();
		}
		if (s) s.style.display='';
		window.parent.document.isSubmitted=false;
		window.parent.setbodyopacity(1);
		if (c > 0) {
		  setConstraint(constraint);
		} else {
		  window.parent.displayWarningMsg(error);
		  if (warning) window.parent.displayWarningMsg(warning);
		  [IFNOT quicksave]window.setTimeout("window.parent.location.href='[url]'",4000);[ENDIF quicksave]
		}
	    } else {
        	    if (warning) {
        	       //window.parent.displayWarningMsg(warning); // not need :set by global fonction
        	       window.setTimeout("window.parent.location.href='[url]'",4000);
        	    } else {
        		[IFNOT quicksave]window.parent.location.href='[url]';[ENDIF quicksave]
        		}
        	    }
	
    }
    window.parent.viewwait(false);
}
</script>
</head>
</html>
