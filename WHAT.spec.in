#! /:/bin/rpm
#
#  File: libwhat.spec
#  $Id: WHAT.spec.in,v 1.27 2003/08/12 12:17:05 eric Exp $
#
#  This is the SPEC file for the What CORE
#  Anakeen What Application
# Conditional build
#  _with_cerbere2       - make rpm for cerbere 2.0
#

%define apachedir /etc/httpd
%define destdir /home/httpd/what

Summary: What Hosting Application Toolkit
Name: @PACKAGE@
Version: @VERSION@
Release: @RELEASE@
Copyright: GPL
Group: Applications/Web
Source: ftp://ftp.souillac.anakeen.com/pub/anakeen/%{name}-%{version}.tar.gz
# post-2.2.0 fix (can go away with next release):
Vendor: Anakeen           
URL: http://www.anakeen.com/
Packager: Yannick Le Briquer <yannick.lebriquer@anakeen.com>
BuildArchitectures: noarch
BuildRoot: %{_tmppath}/%{name}-%{version}-root-%(id -u -n)
Conflicts: AUTHENT USERS CORE APPMNG ACCESS libwhat libjs
BuildRequires: docbook-dtd41-sgml
BuildRequires: docbook-utils
Requires: php >= 4.2
Requires: apache
Requires: postgresql >= 7.2
Requires: postgresql-module-plpgsql
Requires: php-pgsql
Requires: php-gettext
Requires: php-pcre
Requires: php-cgi
Requires: php-mhash
Requires: apache-mod_auth
Requires: apache-mod_auth_pam
Requires: apache-mod_dir
Requires: pam_what >= 0.2.0
Requires: ankpsql-tools
Requires: gettext
Requires: gettext-devel > 0.11
Prereq: apache
Prereq: grep
Prereq: SysVinit

%description
The WHAT application toolkit gives common interface element to develop web applications


%prep
%setup -q -n %{name}-%{version}

%build

%install
autoconf
./configure --with-pubrule=`pwd`
make -i pubdir=$RPM_BUILD_ROOT%{destdir} 

%clean
[ "$RPM_BUILD_ROOT" != "/" ] && rm -rf $RPM_BUILD_ROOT

%post

if [ "$1" = 1 ] ; then

  # Add apache options for what
  if [ -f /etc/httpd/conf/httpd.conf ] ; then
     echo "Include %{destdir}/apache.conf" >>/etc/httpd/conf/httpd.conf
  else
     echo "Include %{destdir}/apache.conf" >>/etc/httpd/httpd.conf
  fi

  # Restart Apache if running
  run=`/etc/rc.d/init.d/httpd status |grep pid|wc -l`
  if [ $run = 1 ] ; then
     /etc/rc.d/init.d/httpd restart
  fi

else   

  # just update
  echo
fi
%{destdir}/wstop


%preun


%postun

  if [ "$1" = 0 ] ; then 
    if [ -f /etc/httpd/conf/httpd.conf ] ; then
       grep -v "Include %{destdir}/apache.conf" /etc/httpd/conf/httpd.conf >/etc/httpd/conf/httpd.conf.tmp
       mv /etc/httpd/conf/httpd.conf.tmp /etc/httpd/conf/httpd.conf
    else
       grep -v "Include %{destdir}/apache.conf" /etc/httpd/httpd.conf >/etc/httpd/httpd.conf.tmp
       mv /etc/httpd/httpd.conf.tmp /etc/httpd/httpd.conf
    fi

    # Restart Apache if running
    run=`/etc/rc.d/init.d/httpd status |grep pid|wc -l`
    if [ $run = 1 ] ; then
       /etc/rc.d/init.d/httpd restart
    fi
  fi


%files
%defattr(-,root,root)
%dir %{destdir}
%doc ChangeLog
%dir %{destdir}/ACCESS
%dir %{destdir}/API
%dir %{destdir}/APPMNG
%dir %{destdir}/AUTHENT
%dir %{destdir}/STYLE
%dir %{destdir}/USERS
%dir %{destdir}/CORE
%dir %{destdir}/WHAT
%dir %{destdir}/expire

%{destdir}/ACCESS/*
%{destdir}/API/*
%{destdir}/APPMNG/*
%{destdir}/AUTHENT/*
%{destdir}/STYLE/*
%{destdir}/USERS/*
%{destdir}/CORE/*
%{destdir}/WHAT/*
%{destdir}/expire/*

%{destdir}/apache.conf
%{destdir}/guest.php
%{destdir}/index.php
%{destdir}/locale
%{destdir}/wcheck
%{destdir}/whattext
%{destdir}/wsh.php
%{destdir}/wstop
%{destdir}/wstart
%{destdir}/log.sh
%config(noreplace) %{destdir}/dbaccess.php
%config(noreplace) /etc/pam.d/httpd
%config(noreplace) /etc/pam.d/httpdwa

%changelog
* Tue Oct 30 2000 Yannick Le Briquer <yannick.lebriquer@anakeen.com>
- Build first RPM

