#!/bin/bash

set -e

if [ -z "$wpub" ]; then
    echo "Undefined or empty wpub environment variable!"
    exit 1
fi

if [ -z "$pgservice_core" ]; then
    echo "Undefined or empty pgservice_core!"
    exit 1
fi



PGSERVICE="$pgservice_core" psql --set ON_ERROR_STOP=on -f - << SQL
    delete from paramdef where name='CORE_LCDATE';
    delete from paramv where name='CORE_LCDATE';
    alter table family.documents drop column if exists svalues;
    alter table family.documents drop column if exists fulltext;
    alter table family.documents drop column if exists values;
    alter table family.documents drop column if exists attrids;
    alter table docread drop column if exists svalues;
    alter table docread drop column if exists fulltext;
    alter table docread drop column if exists values;
    alter table docread drop column if exists attrids;
    -- complete search schema
    update family.documents set id=id;
SQL
RET=$?
if [ $RET -ne 0 ]; then
    echo "Error ."
    exit $RET
fi



PGSERVICE="$pgservice_core" psql --set ON_ERROR_STOP=on -f - << SQL
    \i $wpub/CORE/core_migr33.sql
    select pg_temp.moveFileContent();
SQL
RET=$?
if [ $RET -ne 0 ]; then
    echo "Error ."
    exit $RET
fi

exit 0
