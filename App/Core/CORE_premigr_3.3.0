#!/bin/bash

set -e

if [ -z "$wpub" ]; then
    echo "Undefined or empty wpub environment variable!"
    exit 1
fi

if [ -z "$pgservice_core" ]; then
    echo "Undefined or empty pgservice_core!"
    exit 1
fi

PGSERVICE="$pgservice_core" psql --set ON_ERROR_STOP=on -f "$wpub"/FDL/fdl.sql

PGSERVICE="$pgservice_core" psql --set ON_ERROR_STOP=on -f - -a << SQL

\i $wpub/CORE/core_migr33.sql

DROP TRIGGER IF EXISTS  tfldrel on fld;
DROP FUNCTION if exists reldocfld();
DROP FUNCTION if exists getreldocfld();
ALTER TABLE docread add column fromname text;
ALTER TABLE doc add column fromname text;


SELECT pg_temp.deleteAllViews('family');
select pg_temp.renameFamilyTable();

ALTER TABLE IF EXISTS public.docfam set schema family;
ALTER TABLE if exists family.docfam rename to families;
ALTER TABLE IF EXISTS public.doc set schema family;
ALTER TABLE if exists family.doc rename to documents;
ALTER SEQUENCE IF EXISTS seq_id_doc set schema family;
ALTER SEQUENCE IF EXISTS seq_id_tdoc set schema family;
update family.documents set fromname = family.families.name from family.families where family.families.id= family.documents.fromid;
update docread set fromname = family.families.name from family.families where family.families.id= docread.fromid;

select pg_temp.dropAllTriggers();
select pg_temp.convertAllMultiple();

ALTER TABLE IF EXISTS dav.locks ALTER COLUMN token TYPE text;
ALTER TABLE IF EXISTS dav.locks ALTER COLUMN owner TYPE text;
ALTER TABLE IF EXISTS dav.properties ALTER COLUMN name TYPE text;
ALTER TABLE IF EXISTS dav.properties ALTER COLUMN ns TYPE text;
ALTER TABLE IF EXISTS dav.sessions ALTER COLUMN session TYPE text;
ALTER TABLE IF EXISTS dav.sessions ALTER COLUMN owner TYPE text;
ALTER TABLE IF EXISTS public.usertoken ALTER COLUMN token TYPE text;
ALTER TABLE IF EXISTS public.paramv ALTER COLUMN name TYPE text;
ALTER TABLE IF EXISTS public.paramv ALTER COLUMN type TYPE text;
ALTER TABLE IF EXISTS public.lang ALTER COLUMN lang TYPE text;
ALTER TABLE IF EXISTS public.lang ALTER COLUMN code TYPE text;
ALTER TABLE IF EXISTS public.lang ALTER COLUMN fmt TYPE text;
ALTER TABLE IF EXISTS public.sessions ALTER COLUMN id TYPE text;
ALTER TABLE IF EXISTS public.session_cache ALTER COLUMN index TYPE text;
ALTER TABLE IF EXISTS public.session_conf ALTER COLUMN key TYPE text;
ALTER TABLE IF EXISTS public.session_conf ALTER COLUMN val TYPE text;
ALTER TABLE IF EXISTS public.session_vars ALTER COLUMN key TYPE text;
ALTER TABLE IF EXISTS public.session_vars ALTER COLUMN val TYPE text;
ALTER TABLE IF EXISTS public.vaultdiskdirstorage ALTER COLUMN l_path TYPE text;
ALTER TABLE IF EXISTS public.vaultdiskfsstorage ALTER COLUMN r_path TYPE text;
ALTER TABLE IF EXISTS public.vaultdiskstorage ALTER COLUMN name TYPE text;

DROP INDEX IF EXISTS title_docread;
CREATE INDEX title_docread ON docread USING gin (title gin_trgm_ops);

SELECT pg_temp.dropDocTitleIndexes();
SELECT pg_temp.renameIndexes();

SQL

exit 0
