#!/bin/bash

set -e

if [ -z "$wpub" ]; then
    echo "Undefined or empty wpub environment variable!"
    exit 1
fi

if [ -z "$pgservice_core" ]; then
    echo "Undefined or empty pgservice_core!"
    exit 1
fi

PGSERVICE="$pgservice_core" psql --set ON_ERROR_STOP=on -f "$wpub"/FDL/fdl.sql
PGSERVICE="$pgservice_core" psql --set ON_ERROR_STOP=on -f - << SQL

\i $wpub/CORE/core_migr33.sql

DROP TRIGGER IF EXISTS  tfldrel on fld;
DROP FUNCTION if exists reldocfld();
DROP FUNCTION if exists getreldocfld();
ALTER TABLE docread add column fromname text;
ALTER TABLE doc add column fromname text;


SELECT pg_temp.deleteAllViews('family');
select pg_temp.renameFamilyTable();

ALTER TABLE IF EXISTS public.docfam set schema family;
ALTER TABLE if exists family.docfam rename to families;
ALTER TABLE IF EXISTS public.doc set schema family;
ALTER TABLE if exists family.doc rename to documents;
ALTER SEQUENCE IF EXISTS seq_id_doc set schema family;
ALTER SEQUENCE IF EXISTS seq_id_tdoc set schema family;
update family.documents set fromname = family.families.name from family.families where family.families.id= family.documents.fromid;
update docread set fromname = family.families.name from family.families where family.families.id= docread.fromid;



select pg_temp.dropAllTriggers();
select pg_temp.convertAllMultiple();

SQL
RET=$?
if [ $RET -ne 0 ]; then
    echo "Error adding column rules to table style."
    exit $RET
fi

exit 0
