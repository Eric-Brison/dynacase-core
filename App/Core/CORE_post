#!/bin/bash
if [ "$dbpsql" == "" ]; then
  . /etc/freedom.conf
   wchoose -b
fi

. $wpub/log.sh


#------------------------------
#post installation
#------------------------------
if [ "$1" = "I" ] ; then

  run=`ps ax | grep postmaster`
  if [ $? != 0 ] ; then
    echo "postgresql is not running ..Init is delayed"
    exit 1
  fi

  log "Create $dbname database"
  createdb --encoding LATIN1 --username=postgres --host=$dbhost --port=$dbport $dbname
  
  if [ $? != 0 ] ; then
    log "cannot create db $dbname"
    exit 1
  fi
  log "Create anakeen database user"
  createuser -d -a --username=postgres --host=$dbhost --port=$dbport anakeen
 
  log "Add plpgsql language"
  createlang --username=postgres --dbname=template1 plpgsql

  log "Add plpgsql functions"
  psql  --username=postgres $dbpsql -f $wpub/WHAT/getprivilege.sql
  echo "ALTER DATABASE $dbname set DateStyle = sql,european;" | psql  --username=postgres $dbpsql
  log "Register DB $dbname for automatic dump"
  ll=0
  if [ -f /etc/ankpsql-tools/base-list ] ; then
    ll=`cat /etc/ankpsql-tools/base-list | grep "^$dbname$" | wc -l`
  fi
  if [ $ll -eq 0 ]; then 
    echo "Register DB $dbname for automatic dump"
    echo "$dbname" >> /etc/ankpsql-tools/base-list
  fi


  # Add logrotate
  echo "/var/log/what.log {"               >  /etc/logrotate.d/what
  echo "   missingok"                      >> /etc/logrotate.d/what
  echo "   postrotate"                     >> /etc/logrotate.d/what
  echo "   /usr/bin/killall -HUP syslog-ng"  >> /etc/logrotate.d/what
  echo "   endscript"                      >> /etc/logrotate.d/what
  echo "}"                                 >> /etc/logrotate.d/what


  /usr/bin/php -q $wpub/API/updateclass.php   --class=Application
  /usr/bin/php -q $wpub/API/updateclass.php   --class=Action
  /usr/bin/php -q $wpub/API/updateclass.php   --class=Style
  /usr/bin/php -q $wpub/API/updateclass.php   --class=ParamDef
  /usr/bin/php -q $wpub/API/updateclass.php   --class=Param
  /usr/bin/php -q $wpub/API/updateclass.php   --class=User
  /usr/bin/php -q $wpub/API/updateclass.php   --class=Group
  /usr/bin/php -q $wpub/API/updateclass.php   --class=Permission
  /usr/bin/php -q $wpub/API/updateclass.php   --class=Acl
  /usr/bin/php -q $wpub/API/updateclass.php   --class=Session
  $wpub/wsh.php  --api=appadmin


fi


#------------------------------
#post update
#------------------------------
if [ "$1" = "U" ] ; then

  #add permission functionnalities
  su - postgres -c "psql $dbname anakeen -f $wpub/WHAT/getprivilege.sql"
  $wpub/wsh.php  --api=import_size 
  $wpub/wsh.php  --api=import_style --name=RED
  $wpub/wsh.php  --api=import_style --name=GREEN
  $wpub/wsh.php  --api=import_style --name=AQUA
  $wpub/wsh.php  --api=import_style --name=BLUE
  $wpub/wsh.php  --api=import_style --name=CARAMEL
  $wpub/wsh.php  --api=import_style --name=BLACK
  $wpub/wsh.php  --api=import_style --name=BRUSHED
  echo 'delete from permission where abs(id_acl) not in (select id from acl where acl.id_application=permission.id_application)' | psql $dbname anakeen

fi
#------------------------------
#post uninstallation
#------------------------------
if [ "$1" = "D" ] ; then

  set -e

  grep -v 'Include %{destdir}/apache.conf' /etc/httpd/conf/httpd.conf > /tmp/httpd.conf
  mv /tmp/httpd.conf /etc/httpd/conf/httpd.conf

  # Remove what from syslog
  echo "Remove what.log from syslog"
  cp /etc/syslog.conf /etc/syslog.conf.sav
  cat /etc/syslog.conf.sav | grep -v "^local6.*/var/log/what.log.*$" > /etc/syslog.conf
  /etc/rc.d/init.d/syslog restart
  rm -f /etc/logrotate.d/what

  # drop anakeen database and user
  log "The $dbname database will be dropped, we save a dump in /tmp/anakeen$$.dump"
  sulog  postgres  "pg_dump -d $dbname >/tmp/anakeen$$.dump"
  sulog  postgres  "dropuser anakeen" 
  sulog  postgres  "dropdb $dbname"

  log "Unregister DB $dbname for automatic dump"
  mv /etc/ankpsql-tools/base-list /etc/ankpsql-tools/base-list.old
  cat /etc/ankpsql-tools/base-list.old | grep -v "^$dbname$" > /etc/ankpsql-tools/base-list
  rm -f /etc/ankpsql-tools/base-list.old
fi

exit 0
